<!DOCTYPE html>
<html>

<head>
    <title>Contributions | Strava</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="nav_bar.css">
    <link rel="stylesheet" href="button.css">
    <link rel="stylesheet" href="radio_buttons.css">
    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/png" href="strava-favicon.png" sizes="180x180">
    <style>
    </style>
</head>

<body>
    <div class="nav-bar-container">
        <div class="nav-bar">
            <a href="https://www.strava.com">
                <img src="strava-logo.svg" alt="Strava" id="logo-strava">
            </a>
            <div class="nav-bar-element">
                <h1>Contributions Graph</h1>
            </div>
            <img src="profile.svg" alt="profile" id="profile">
        </div>
    </div>
    <a id="authorize_button" class="button"
        href="http://www.strava.com/oauth/authorize?client_id=125585&response_type=code&redirect_uri=http://localhost:8000/exchange_token.html&approval_prompt=force&scope=activity:read_all">
        Authorize Access
    </a>
    <ul id="activities_types">
        <li class="activity-type" selected="true">Run</li>
        <li class="activity-type">Ride</li>
    </ul>
    <p>This is a paragraph of text.</p>
    <p>This is another paragraph of text.</p>
</body>

<script>
    // Get the code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const access_token = urlParams.get('access_token');

    var data = [];
    var date_data = {};
    var result = undefined;

    async function get_data_from_page(page, token, contiue = true) {
        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer " + token);
        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };
        const url = "https://www.strava.com/api/v3/athlete/activities?page=" + page;
        response = await fetch(url, requestOptions);
        if (response.status == 200) {
            result = await response.json();
            // append result.data to data
            data = data.concat(result);
            // extract_date_dict(result);
            // draw_graph();
            if (contiue && result.length > 0) {
                await get_data_from_page(page + 1, token, contiue);
            }
        } else {
            alert("Invalid token");
        }
    }
    get_data_from_page(1, access_token, contiue = false)
    // get_data_from_page(1, access_token, contiue = true)
    function extract_date_dict(data) {
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            // date
            var date = item.start_date_local.substr(0, 10);
            if(date == null || date == undefined){
                date = item.start_date.substr(0, 10);
            }
            if(date == null || date == undefined){
                continue;
            }
            // time
            var time = item.moving_time;
            if(time == null || time == undefined){
                time = item.elapsed_time;
            }
            if(time == null || time == undefined){
                time = 0;
            }
            // type
            var type = item.type.toLowerCase();
            if(type == null || type == undefined){
                sport_type = item.time.toLowerCase();
            }
            if(type == null || type == undefined){
                sport_type = "run";
            }
            if (date in date_data) {
                date_data[date][sport_type].time += time;
                date_data[date][sport_type].number += 1;
            }
            else {
                date_data[date] = {
                    sport_type: {
                        time: time, 
                        number: 1
                    }
                };
            }
        }
        return date_data;
    }



</script>
<script src="radio_buttons.js"></script>

</html>