<!DOCTYPE html>
<html>

<head>
    <title>Contributions | Strava</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="nav_bar.css">
    <link rel="stylesheet" href="inputs.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="graph.css">
    <link rel="icon" type="image/png" href="strava-favicon.png" sizes="180x180">
    <style>
    </style>
</head>

<body>
    <div class="nav-bar-container">
        <div class="nav-bar">
            <a href="https://www.strava.com">
                <img src="strava-logo.svg" alt="Strava" id="logo-strava">
            </a>
            <div class="nav-bar-element">
                <h1>Contributions Graph</h1>
            </div>
            <img src="profile.svg" alt="profile" id="profile">
        </div>
    </div>
    <a id="authorize_button" class="button"
        href="http://www.strava.com/oauth/authorize?client_id=125585&response_type=code&redirect_uri=http://localhost:8000/exchange_token.html&approval_prompt=force&scope=activity:read_all">
        Authorize Access
    </a>

    <div class="line">
        <ul id="activities_types">
            <li class="activity-type">Run</li>
            <li class="activity-type" selected="true">Ride</li>
        </ul>
        <input id="year_input" name="year" type="number" min="1900" max="2100" step="1" value="2024" />
    </div>

    <div id="graph">
        <div class="empty"></div>
        <div class="months"></div>

        <div class="days">
            <li>Sun</li>
            <li>Mon</li>
            <li>Tue</li>
            <li>Wed</li>
            <li>Thu</li>
            <li>Fri</li>
            <li>Sat</li>
        </div>
        <div class="squares"><!-- added via javascript --></div>

        <div class="empty"></div>
        <div class="legend">
            <a href="count.html" class="hidden-link">Learn how we count contributions</a>
            <div class="legend">
                <span>Less</span>
                <div id="data-level-legend" class="squares">
                    <li data-level="0"></li>
                    <li data-level="1"></li>
                    <li data-level="2"></li>
                    <li data-level="3"></li>
                    <li data-level="4"></li>
                    <li data-level="5"></li>
                </div>
                <span>More</span>
            </div>
        </div>
    </div>

</body>

<script>
    const squares = document.querySelector('.squares');
    const months = document.querySelector('.months');

    // Get the code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const access_token = urlParams.get('access_token');

    var activities_list = ["Run", "Ride"];
    var selected_activities_list = ["Ride"];
    var data = [];
    var date_data = {};
    var min_date = new Date();
    var end_date = new Date();
    var begin_date = new Date();


    function draw_graph() {
        var column_size = undefined;
        if (window.screen.width > 1100) {
            column_size = 20;
        } else if (window.screen.width > 850) {
            column_size = 15;
        } else if (window.screen.width > 600) {
            column_size = 11;
        } else {
            column_size = 8;
        }
        today_date = new Date();
        // extract min and max
        squares.innerHTML = '';
        if (begin_date.getDay() != 0) {
            for (var i = 0; i < begin_date.getDay(); i++) {
                squares.insertAdjacentHTML('beforeend', `<li data-level="none"></li>`);
            }
        }
        date = new Date(begin_date);
        mini = 1000000000;
        maxi = 0;
        current_month = date.toGMTString().split(' ')[2];
        months.innerHTML = '';
        months.insertAdjacentHTML('beforeend', `<li class="month">${current_month}</li>`);
        var monthsGridTemplateColumns = "";
        var c = 0;
        var last_col = 0;
        while (date <= end_date) {
            if (date.toGMTString().split(' ')[2] != current_month) {
                current_month = date.toGMTString().split(' ')[2];
                months.insertAdjacentHTML('beforeend', `<li class="month">${current_month}</li>`);
                monthsGridTemplateColumns += (1 + Math.floor(c / 7) - last_col) * column_size + 'px ';
                last_col = 1 + Math.floor(c / 7);
            }
            c++;
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var total_time = 0;
                var total_number = 0;
                for (const [key, value] of Object.entries(date_data[date_str])) {
                    if (selected_activities_list.includes(key)) {
                        total_time += value.time;
                        total_number += value.number;
                    }
                }
                if (total_time > maxi) {
                    maxi = total_time;
                }
                if (total_time < mini) {
                    mini = total_time;
                }
            }
            date.setDate(date.getDate() + 1);
        }
        monthsGridTemplateColumns += (1 + Math.floor(c / 7) - last_col) * 20 + 'px ';
        months.style.gridTemplateColumns = monthsGridTemplateColumns;
        function format_time(t) {
            var tenths = Math.floor(t % 10);
            t = Math.floor(t / 10);
            var seconds = Math.floor(t % 60);
            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            var minutes = Math.floor(t / 60);
            return minutes + ":" + seconds + '.' + tenths;
        }
        // color squares
        date = new Date(begin_date);
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var total_time = 0;
                var total_number = 0;
                for (const [key, value] of Object.entries(date_data[date_str])) {
                    if (selected_activities_list.includes(key)) {
                        total_time += value.time;
                        total_number += value.number;
                    }
                }
                if (total_number > 0) {
                    var level = Math.round(1 + (total_time - mini) / (maxi - mini) * 5);
                    squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"></li>`);
                } else {
                    var level = 0;
                    if (date > today_date) {
                        level = -1;
                    } else {
                        level = 0;
                    }
                    squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"></li>`);
                }
            } else {
                var level = 0;
                if (date > today_date) {
                    level = -1;
                } else {
                    level = 0;
                }
                squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"></li>`);
            }
            date.setDate(date.getDate() + 1);
        }
    }

    async function get_data_from_page(page, token, contiue = true) {
        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer " + token);
        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };
        const url = "https://www.strava.com/api/v3/athlete/activities?page=" + page;
        response = await fetch(url, requestOptions);
        if (response.status == 200) {
            result = await response.json();
            // append result.data to data
            data = data.concat(result);
            extract_date_dict(result);
            draw_graph();
            if (contiue && result.length > 0) {
                await get_data_from_page(page + 1, token, contiue);
            }
        } else {
            alert("Invalid token");
        }
    }
    function extract_date_dict(data) {
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            // date
            var date = item.start_date_local.substr(0, 10);
            if (date == null || date == undefined) {
                date = item.start_date.substr(0, 10);
            }
            if (date == null || date == undefined) {
                continue;
            }
            // time
            var time = item.moving_time;
            if (time == null || time == undefined) {
                time = item.elapsed_time;
            }
            if (time == null || time == undefined) {
                time = 0;
            }
            // type
            var sport_type = item.type;
            if (sport_type == null || sport_type == undefined) {
                sport_type = item.sport_type;
            }
            if (sport_type == null || sport_type == undefined) {
                sport_type = "Run";
            }
            if (!activities_list.includes(sport_type)) {
                activities_list.push(sport_type);
                activities_types.innerHTML += "<li class='activity-type'>" + sport_type + "</li>";
                listActivitiesTypeClick();
            }
            //// store item
            if (date in date_data) {
                if (sport_type in date_data[date]) {
                    date_data[date][sport_type].time += time;
                    date_data[date][sport_type].number += 1;
                }
                else {
                    date_data[date][sport_type] = {
                        time: time,
                        number: 1
                    };
                }
            }
            else {
                date_data[date] = {}
                date_data[date][sport_type] = {
                    time: time,
                    number: 1
                };
                if (new Date(date) < min_date) {
                    min_date = new Date(date);
                }
            }
        }
        return date_data;
    }
    function no_details() {
        details.innerHTML = "";
    }
    function display_details(date_str){
        var date = new Date(date_str);
        date_details.innerText = date.toDateString();
    }
    function get_default_dates() {
        end_date = new Date();
        end_date.setTime(end_date.getTime() + (24 * 60 * 60 * 1000 + 500)) // add one day
        begin_date = new Date();
        begin_date.setFullYear(end_date.getFullYear() - 1);
        while (begin_date.getDay() != 0) {
            begin_date.setDate(begin_date.getDate() + 1);
        }
    }
    year_input.onchange = function () {
        begin_date.setFullYear(year_input.value);
        end_date.setFullYear(year_input.value);
        begin_date.setMonth(0);
        begin_date.setDate(1);
        end_date.setMonth(11);
        end_date.setDate(31);
        // end_date.setTime(end_date.getTime()+(24*60*60*1000)) // add one day
        draw_graph();
    }

    get_default_dates();
    draw_graph();
    get_data_from_page(1, access_token, contiue = true);

</script>
<script src="radio_buttons.js"></script>

</html>