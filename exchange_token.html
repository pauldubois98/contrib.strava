<!DOCTYPE html>
<html>

<head>
    <title>Exchanging Tokens</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="nav_bar.css">
    <link rel="stylesheet" href="button.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            font-family: MaisonNeueThin, SegoeUI, -apple-system, system-ui, Arial, sans-serif, Symbol;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="nav-bar-container">
        <div class="nav-bar">
            <img src="strava-logo.svg" alt="Strava" id="logo-strava">
            <div class="nav-bar-element">
                <h1>Loading - Temporary page</h1>
            </div>
            <img src="profile.svg" alt="profile" id="profile">
        </div>
    </div>
    <p>You should be redirected soon.</p>
    <a href="index.html" class="button">Reconnect</a>
</body>

<script>
    // Get the code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    // Exchange the code for an access token
    const myHeaders = new Headers();
    const formdata = new FormData();
    formdata.append("client_id", "125585");
    formdata.append("client_secret", "73c852a5a0215f5947cea3a2f906cbf5cccf044d");
    formdata.append("code", code);
    formdata.append("grant_type", "authorization_code");

    const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: formdata,
        redirect: "follow"
    };

    var txt = undefined;
    var json = undefined;

    fetch("https://www.strava.com/oauth/token", requestOptions)
        .then((response) => response.text())
        .then((result) => parseResponse(result))
        .catch((error) => console.error(error));

    function parseResponse(response) {
        txt = response;
        json = JSON.parse(txt);
        console.log(json);
        // console.log(json.access_token);

        // Save the access_token & refresh_token to local storage
        localStorage.setItem('access_token', json.access_token);
        localStorage.setItem('refresh_token', json.refresh_token);

        // redirect to the index page
        window.location.href = 'http://localhost:8000/index.html?access_token=' + json.access_token;
    }

</script>

</html>